/**
 * Minified by jsDelivr using Terser v5.19.2.
 * Original file: /npm/1@0.1.2/index.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
"use strict";var EventEmitter=require("events").EventEmitter,zmq=require("zmq"),mdns=require("mdns2"),mout=require("mout"),uuid=require("node-uuid"),freeport=require("./lib/freeport"),async=require("async"),inherits=require("util").inherits,One=function(t){EventEmitter.call(this),t=t||{},this._service=t.service||"unnamedService",this._cluster=t.cluster||"defaultCluster",this._id=t.id||uuid.v4(),this._pubPort=t.port,this._address=t.address||"0.0.0.0",this._inCluster=!1,this._advertising=!1,this._clusterTopology={},this._pub=null,this._sub=null,this._ad=null,this._browser=null,this._adInfo=null};inherits(One,EventEmitter),One.prototype.getId=function(){return this._id},One.prototype.getCluster=function(){return this._cluster},One.prototype.getClusterTopology=function(){return this._clusterTopology},One.prototype.inCluster=function(){return this._inCluster},One.prototype.advertising=function(){return this._advertising},One.prototype.join=function(t){return this._pub=zmq.socket("pub"),this._sub=zmq.socket("sub"),this._sub.on("message",this._handleMessage.bind(this)),async.waterfall([function(t){this._pubPort?t():freeport(function(e,s){if(e)return t(e);this._pubPort=s,t()}.bind(this))}.bind(this),function(t){this._pub.bind(this._getBind(this._address,this._pubPort),t)}.bind(this),function(t){this._startDiscovery(t)}.bind(this)],function(e){if(e)return this._error(e,t);this._inCluster=!0,this.emit("join",this._cluster),t&&process.nextTick(t.bind(null,null,this._cluster))}.bind(this)),this},One.prototype.leave=function(t){var e=this;return async.waterfal([function(t){e._stopDiscovery(t)},function(t){e._advertising?e.stopAdvertise(t):t()},function(t){e._sub.removeAllListeners(),e._sub.close(),e._pub.close(),e._sub=null,e._pub=null,e._inCluster=!1,t()}],(function(s){if(s)return e._error(s,t);e._clusterTopology={},e._emitter.emit("leave",e._cluster),t&&process.nextTick(t.bind(null,null,e._cluster))})),e},One.prototype.advertise=function(t,e){"function"==typeof t&&(e=t,t=null),t=t||{};var s={name:this._id,txtRecord:{cluster:this._cluster}};return mout.object.mixIn(s.txtRecord,t),this._ad=mdns.createAdvertisement(mdns.tcp(this._service),this._pubPort,s,function(t){if(t)return this._error(t,e);this._advertising=!0,this._adInfo={service:this._service,port:this._pubPort,banner:s},this.emit("advertise_start",this._adInfo),e&&process.nextTick(e.bind(null,null,this._adInfo))}.bind(this)),this._ad.start(),this},One.prototype.stopAdvertise=function(t){return this._ad.stop(),this._ad=null,this._advertising=!1,this.emit("advertise_stop",this._adInfo),t&&process.nextTick(t.bind(null,null,this._adInfo)),this},One.prototype.subscribe=function(t,e){return this._inCluster?(this._assertChanValid(t,e),this._sub.subscribe(t+":"),this.emit("subscribe",t),e&&process.nextTick(e.bind(null,null,t)),this):this._error(new Error("Can't subscribe while not in cluster"),e)},One.prototype.unsubscribe=function(t,e){return this._inCluster?(this._sub.unsubscribe(t+":"),this.emit("unsubscribe",t),e&&process.nextTick(e.bind(null,null,t)),this):this._error(new Error("Can't unsubscribe while not in cluster"),e)},One.prototype.publish=function(t,e){return this._inCluster?(this._assertChanValid(t),this.emit("publish",t,e),this._pub.send(t+":"+e),this):this._error(new Error("Can't publish while not in cluster"))},One.prototype._startDiscovery=function(t){return this._browser=mdns.createBrowser(mdns.tcp(this._service),{resolverSequence:[mdns.rst.DNSServiceResolve(),mdns.rst.getaddrinfo({families:[4]}),mdns.rst.makeAddressesUnique()]}),this._browser.on("serviceUp",this._handleNodeUp.bind(this)),this._browser.on("serviceDown",this._handleNodeDown.bind(this)),this._browser.start(),t(),this},One.prototype._stopDiscovery=function(t){return this._browser.stop(),this._browser.removeListener("serviceUp",this._handleNodeUp),this._browser.removeListener("serviceDown",this._handleNodeDown),this._browser=null,t(),this},One.prototype._handleNodeUp=function(t){if(!mout.lang.isObject(this._clusterTopology[t.name])&&t.txtRecord.cluster===this._cluster){var e={id:t.name,timestamp:(new Date).toJSON(),address:t.addresses[0],port:t.port};e.details=mout.lang.deepClone(t.txtRecord),delete e.details.cluster,this._clusterTopology[t.name]=e,this._sub.connect(this._getBind(e.address,e.port)),this.emit("node_up",e)}},One.prototype._handleNodeDown=function(t){if(mout.lang.isObject(this._clusterTopology[t.name])){var e=mout.lang.deepClone(this._clusterTopology[t.name]);delete this._clusterTopology[t.name],this.emit("node_down",e)}},One.prototype._handleMessage=function(t){var e=(t=t.toString()).indexOf(":"),s=t.substr(0,e),i=t.substr(e+1);this.emit("message",s,i)},One.prototype._getBind=function(t,e){return"tcp://"+t+":"+e},One.prototype._assertChanValid=function(t,e){t.indexOf(":")>-1&&this._error(new Error("Can't use commas in channel names"),e)},One.prototype._error=function(t,e){if("function"==typeof e)return e(t);this.emit("error",t)},module.exports=One;
//# sourceMappingURL=/sm/be15bf7b9b423a702042b7fa30f4473f0b58d74e330b5fc1b55f0017f8d05084.map